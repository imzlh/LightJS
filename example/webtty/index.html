<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页终端</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --panel-bg: #2d2d2d;
            --accent-color: #4CAF50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196F3;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #f5f5f5;
                --text-color: #333333;
                --panel-bg: #ffffff;
                --accent-color: #2E7D32;
            }
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .header {
            padding: 10px 20px;
            background-color: var(--panel-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--accent-color);
        }
        
        #terminal-container {
            flex: 1;
            padding: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            background-color: var(--panel-bg);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        .control-panel:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .control-btn {
            padding: 8px 12px;
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .control-btn i {
            font-size: 14px;
        }
        
        select, input {
            padding: 8px;
            border-radius: 6px;
            background-color: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.1);
            outline: none;
        }
        
        .status-bar {
            padding: 8px 20px;
            background-color: var(--panel-bg);
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: rgba(138, 126, 126, 0.7);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-item .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-color);
        }
        
        .status-item.disconnected .indicator {
            background-color: var(--error-color);
        }
        
        .notification-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 99;
            display: none;
        }
        
        .notification {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: rgba(255,255,255,0.05);
        }
        
        .notification.info {
            border-left: 3px solid var(--info-color);
        }
        
        .notification.warning {
            border-left: 3px solid var(--warning-color);
        }
        
        .notification.error {
            border-left: 3px solid var(--error-color);
        }
        
        .notification.success {
            border-left: 3px solid var(--accent-color);
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 0.8em;
            color: rgba(255,255,255,0.5);
            text-align: right;
        }
        
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 101;
            width: 400px;
            max-width: 90%;
            display: none;
        }
        
        .settings-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--accent-color);
        }
        
        .settings-group {
            margin-bottom: 15px;
        }
        
        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Web Terminal</div>
        <div>
            <button id="settings-btn" class="control-btn">
                <i class="fas fa-cog"></i> 设置
            </button>
        </div>
    </div>
    
    <div id="terminal-container"></div>
    
    <div class="status-bar">
        <div class="status-item" id="connection-status">
            <span class="indicator"></span>
            <span>连接状态: 未连接</span>
        </div>
        <div class="status-item">
            <span id="terminal-size">80×24</span>
        </div>
    </div>
    
    <div class="control-panel">
        <select id="font-selector" class="control-btn">
            <option value="12px">12px</option>
            <option value="14px">14px</option>
            <option value="16px" selected>16px</option>
            <option value="18px">18px</option>
            <option value="20px">20px</option>
        </select>
        <button id="reconnect-btn" class="control-btn">
            <i class="fas fa-sync-alt"></i> 重连
        </button>
        <button id="clear-btn" class="control-btn">
            <i class="fas fa-trash-alt"></i> 清屏
        </button>
        <button id="notifications-btn" class="control-btn">
            <i class="fas fa-bell"></i>
            <span id="notification-count">0</span>
        </button>
    </div>
    
    <div class="notification-panel" id="notification-panel">
        <div class="notification info">
            <div class="notification-title">系统通知</div>
            <div>网页终端已准备就绪</div>
            <div class="notification-time">刚刚</div>
        </div>
    </div>
    
    <div class="settings-panel" id="settings-panel">
        <h3 class="settings-title">终端设置</h3>
        
        <div class="settings-group">
            <label class="settings-label">终端主题</label>
            <select id="theme-selector" class="control-btn" style="width: 100%">
                <option value="auto">跟随系统</option>
                <option value="dark">暗色</option>
                <option value="light">亮色</option>
            </select>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">字体设置</label>
            <select id="font-family-selector" class="control-btn" style="width: 100%">
                <option value="Consolas, 'Courier New', monospace">Consolas</option>
                <option value="'Fira Code', monospace">Fira Code</option>
                <option value="'Source Code Pro', monospace">Source Code Pro</option>
                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
            </select>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">光标样式</label>
            <select id="cursor-style-selector" class="control-btn" style="width: 100%">
                <option value="block">方块</option>
                <option value="underline">下划线</option>
                <option value="bar">竖线</option>
            </select>
        </div>
        
        <div class="settings-footer">
            <button id="cancel-settings" class="control-btn">取消</button>
            <button id="save-settings" class="control-btn" style="background-color: var(--accent-color); color: white;">保存</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0.18.0/lib/addon-webgl.min.js"></script>
    <script>
        // 初始化终端
        const term = new Terminal({
            fontSize: 16,
            fontFamily: 'Consolas, "Courier New", monospace',
            cursorBlink: true,
            cursorStyle: 'block',
            theme: {
                background: 'var(--bg-color)',
                foreground: 'var(--text-color)',
                cursor: 'var(--text-color)',
                selection: 'rgba(255, 255, 255, 0.3)'
            },
            padding: '12px'
        });
        
        // 加载插件
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        
        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.loadAddon(new WebglAddon.WebglAddon());
        
        // 打开终端
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();
        
        // 连接状态管理
        let isConnected = false;
        let socket = null;
        
        // 更新终端尺寸显示
        function updateTerminalSize() {
            const col = term.cols;
            const row = term.rows;
            document.getElementById('terminal-size').textContent = `${col}×${row}`;

            if(socket){
                socket.send(JSON.stringify({col, row}));
            }
        }
        
        // 连接WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketUrl = `${protocol}//${host}/@terminal`;
            
            socket = new WebSocket(socketUrl);
            socket.binaryType = 'arraybuffer';

            socket.onopen = () => {
                isConnected = true;
                updateConnectionStatus(true);
                addNotification('success', '连接成功', '已成功连接到终端服务器');
                updateTerminalSize();
                
                const toU8 = any => new Uint8Array(typeof any === 'string' ? new TextEncoder().encode(any) : any);
                // 处理终端输入输出
                term.onData(data => {
                    socket.send(toU8(data));
                });
                
                socket.onmessage = (event) => {
                    term.write(toU8(event.data));
                };
            };
            
            socket.onclose = () => {
                isConnected = false;
                updateConnectionStatus(false);
                addNotification('warning', '连接断开', '终端连接已断开，请手动尝试重新连接...');
                // setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                addNotification('error', '连接错误', error.message || '未知错误');
            };
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.classList.remove('disconnected');
                statusElement.querySelector('span:last-child').textContent = '连接状态: 已连接';
            } else {
                statusElement.classList.add('disconnected');
                statusElement.querySelector('span:last-child').textContent = '连接状态: 未连接';
            }
        }
        
        // 添加通知
        function addNotification(type, title, message) {
            const panel = document.getElementById('notification-panel');
            const countElement = document.getElementById('notification-count');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div>${message}</div>
                <div class="notification-time">${timeString}</div>
            `;
            
            panel.insertBefore(notification, panel.firstChild);
            
            // 更新通知计数
            const count = panel.children.length - 1; // 减去初始的示例通知
            countElement.textContent = count;
            
            // 显示通知面板
            panel.style.display = 'block';
            
            // 5秒后自动隐藏
            setTimeout(() => {
                if (!panel.matches(':hover')) {
                    panel.style.display = 'none';
                }
            }, 5000);
        }
        
        // 初始连接
        connectWebSocket();
        
        // 窗口大小变化时调整终端大小
        window.addEventListener('resize', () => {
            fitAddon.fit();
            updateTerminalSize();
        });
        
        // 控制按钮功能
        document.getElementById('font-selector').addEventListener('change', (e) => {
            term.setOption('fontSize', parseInt(e.target.value));
            fitAddon.fit();
        });
        
        document.getElementById('reconnect-btn').addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
            addNotification('info', '重新连接', '尝试重新连接终端服务器...');
            connectWebSocket();
        });
        
        document.getElementById('clear-btn').addEventListener('click', () => {
            term.clear();
            addNotification('info', '终端已清空', '终端内容已被清除');
        });
        
        document.getElementById('notifications-btn').addEventListener('click', () => {
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-panel').style.display = 'block';
        });
        
        document.getElementById('cancel-settings').addEventListener('click', () => {
            document.getElementById('settings-panel').style.display = 'none';
        });
        
        document.getElementById('save-settings').addEventListener('click', () => {
            // 应用主题设置
            const theme = document.getElementById('theme-selector').value;
            if (theme === 'auto') {
                document.documentElement.style.setProperty('--bg-color', '');
                document.documentElement.style.setProperty('--text-color', '');
                document.documentElement.style.setProperty('--panel-bg', '');
            } else {
                const isDark = theme === 'dark';
                document.documentElement.style.setProperty('--bg-color', isDark ? '#1e1e1e' : '#f5f5f5');
                document.documentElement.style.setProperty('--text-color', isDark ? '#ffffff' : '#333333');
                document.documentElement.style.setProperty('--panel-bg', isDark ? '#2d2d2d' : '#ffffff');
            }
            
            // 应用字体设置
            const fontFamily = document.getElementById('font-family-selector').value;
            term.setOption('fontFamily', fontFamily);
            
            // 应用光标样式
            const cursorStyle = document.getElementById('cursor-style-selector').value;
            term.setOption('cursorStyle', cursorStyle);
            
            document.getElementById('settings-panel').style.display = 'none';
            addNotification('success', '设置已保存', '终端设置已成功应用');
        });
        
        // 处理终端关闭时的清理
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.close();
            }
        });
        
        // 初始通知
        addNotification('info', '系统启动', '网页终端已准备就绪');
    </script>
</body>
</html>
